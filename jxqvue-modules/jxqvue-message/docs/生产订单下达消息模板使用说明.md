# 生产订单下达消息模板使用说明

## 功能概述

当生产订单状态变更为"下达"（状态值为"2"）时，系统会自动发送消息通知给相关用户，提醒他们准备开始工作。

## 消息模板配置

### 1. 模板基本信息
- **模板名称**: 生产订单下达通知
- **模板编码**: PRODUCTION_ORDER_RELEASE
- **模板类型**: PRODUCTION_ORDER
- **消息类型**: 业务消息（2）
- **消息级别**: 重要（2）
- **状态**: 启用（0）

### 2. 模板内容

#### 标题模板
```
生产订单下达通知 - {orderCode}
```

#### 内容模板
```
您好！

生产订单 {orderCode} 已下达，请准备开始工作。

订单详情：
- 订单名称：{orderName}
- 产品名称：{productName}
- 计划数量：{plannedQuantity} {unitName}
- 计划开始时间：{plannedStartDate}
- 计划完成时间：{plannedEndDate}
- 优先级：{priority}

请及时查看订单详情并开始生产准备工作。

如有疑问，请联系相关负责人。

系统自动发送
```

### 3. 模板变量

| 变量名 | 变量编码 | 类型 | 必填 | 说明 |
|--------|----------|------|------|------|
| 订单编码 | orderCode | STRING | 是 | 生产订单编码 |
| 订单名称 | orderName | STRING | 是 | 生产订单名称 |
| 产品名称 | productName | STRING | 是 | 产品物料名称 |
| 计划数量 | plannedQuantity | NUMBER | 是 | 计划生产数量 |
| 单位名称 | unitName | STRING | 是 | 数量单位 |
| 计划开始时间 | plannedStartDate | DATETIME | 否 | 计划开始生产时间 |
| 计划完成时间 | plannedEndDate | DATETIME | 否 | 计划完成生产时间 |
| 优先级 | priority | STRING | 否 | 订单优先级 |

## 技术实现

### 1. 数据库表结构

#### 消息模板表 (message_template)
```sql
INSERT INTO message_template (
    template_name, template_code, template_type, category_id, category_name,
    title_template, content_template, message_type, message_level, variables, status,
    create_by, create_time, remark
) VALUES (
    '生产订单下达通知', 'PRODUCTION_ORDER_RELEASE', 'PRODUCTION_ORDER',
    (SELECT category_id FROM message_template_category WHERE category_code = 'PRODUCTION'),
    '生产管理',
    '生产订单下达通知 - {orderCode}',
    '您好！\n\n生产订单 {orderCode} 已下达，请准备开始工作。\n\n订单详情：\n- 订单名称：{orderName}\n- 产品名称：{productName}\n- 计划数量：{plannedQuantity} {unitName}\n- 计划开始时间：{plannedStartDate}\n- 计划完成时间：{plannedEndDate}\n- 优先级：{priority}\n\n请及时查看订单详情并开始生产准备工作。\n\n如有疑问，请联系相关负责人。\n\n系统自动发送',
    '2', '2', '{"orderCode":"订单编码","orderName":"订单名称","productName":"产品名称","plannedQuantity":"计划数量","unitName":"单位名称","plannedStartDate":"计划开始时间","plannedEndDate":"计划完成时间","priority":"优先级"}',
    '0', 'admin', NOW(), '生产订单状态变更为"下达"时自动发送的通知消息模板'
);
```

#### 消息模板变量表 (message_template_variable)
为每个变量创建对应的记录，定义变量的类型、是否必填、默认值等信息。

### 2. 服务层实现

#### ProductionOrderMessageService
- `sendProductionOrderReleaseNotification()`: 发送生产订单下达通知
- `prepareTemplateVariables()`: 准备模板变量
- `replaceTemplateVariables()`: 替换模板变量
- `getRelatedUserIds()`: 获取相关用户ID列表

#### ErpProductionOrderServiceImpl
在`updateErpProductionOrderStatus()`方法中添加消息发送逻辑：
```java
// 如果状态更新为"下达"（状态值为"2"），发送消息通知
if (result > 0 && "2".equals(erpProductionOrder.getStatus())) {
    try {
        // 获取完整的生产订单信息
        ErpProductionOrder fullOrder = erpProductionOrderMapper.selectErpProductionOrderById(erpProductionOrder.getId());
        if (fullOrder != null) {
            // 获取相关用户ID列表
            List<Long> relatedUserIds = productionOrderMessageService.getRelatedUserIds(fullOrder);
            if (!relatedUserIds.isEmpty()) {
                // 发送生产订单下达通知
                productionOrderMessageService.sendProductionOrderReleaseNotification(fullOrder, relatedUserIds);
            }
        }
    } catch (Exception e) {
        // 消息发送失败不影响主流程，只记录日志
        System.err.println("发送生产订单下达通知失败: " + e.getMessage());
        e.printStackTrace();
    }
}
```

## 使用流程

### 1. 部署步骤
1. 执行SQL脚本创建消息模板和变量
2. 部署Java服务类
3. 配置相关用户获取逻辑

### 2. 触发条件
- 生产订单状态从其他状态变更为"下达"（状态值为"2"）
- 通过`updateErpProductionOrderStatus()`方法更新状态

### 3. 消息发送
1. 系统检测到状态变更为"下达"
2. 获取完整的生产订单信息
3. 根据业务规则获取相关用户ID列表
4. 准备模板变量
5. 替换模板变量生成消息内容
6. 发送消息给相关用户

## 配置说明

### 1. 相关用户获取
需要在`ProductionOrderMessageService.getRelatedUserIds()`方法中实现具体的用户获取逻辑，例如：
- 根据工作中心获取相关用户
- 根据部门获取相关用户
- 根据角色获取相关用户
- 根据订单创建者获取相关用户

### 2. 消息接收者
- 生产管理员
- 车间管理员
- 相关操作人员
- 订单创建者

### 3. 优先级映射
```java
switch (productionOrder.getPriority()) {
    case 1: priorityText = "低"; break;
    case 2: priorityText = "普通"; break;
    case 3: priorityText = "高"; break;
    case 4: priorityText = "紧急"; break;
    default: priorityText = "普通"; break;
}
```

## 测试验证

### 1. 功能测试
1. 创建生产订单
2. 将订单状态更新为"下达"
3. 验证消息是否发送给相关用户
4. 检查消息内容是否正确

### 2. 异常测试
1. 模板不存在时的处理
2. 用户列表为空时的处理
3. 消息发送失败时的处理

## 注意事项

1. **事务处理**: 消息发送失败不应影响订单状态更新
2. **性能考虑**: 避免在事务中执行耗时的消息发送操作
3. **错误处理**: 消息发送失败应记录日志，不影响主流程
4. **用户权限**: 确保只有有权限的用户才能接收消息
5. **模板维护**: 定期检查和更新消息模板内容

## 扩展功能

### 1. 消息规则配置
可以通过消息规则表配置更灵活的消息发送条件：
- 根据订单类型发送不同消息
- 根据优先级发送不同级别的消息
- 根据时间条件发送消息

### 2. 消息模板管理
- 支持在线编辑消息模板
- 支持模板版本管理
- 支持模板预览功能

### 3. 消息统计
- 消息发送统计
- 消息阅读统计
- 消息效果分析
